# PostgreSQL ะะปะฐััะตั ั ะะตะฟะปะธะบะฐัะธะตะน ะธ PgPool

ะญัะพั ะฟัะพะตะบั ะฝะฐัััะฐะธะฒะฐะตั PostgreSQL ะบะปะฐััะตั, ัะพััะพััะธะน ะธะท ะพะดะฝะพะณะพ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ (primary), ะดะฒัั ัะตะฟะปะธะบ (replica) ะธ ะฑะฐะปะฐะฝัะธัะพะฒัะธะบะฐ ะฝะฐะณััะทะบะธ PgPool ะฒ ะบะฐัะตััะฒะต ะฟัะพะบัะธ ะผะตะถะดั ะบะปะธะตะฝัะฐะผะธ ะธ ะบะปะฐััะตัะพะผ.

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโ
โ     Client      โโโโโโถโ     PgPool       โ
โ                 โ     โ  (Port: 9999)    โ
โโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโฌโโโโโโโโ
                                   โ
                        โโโโโโโโโโโโผโโโโโโโโโโโโ
                        โ                      โ
                        โผ                      โผ
               โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
               โ PostgreSQL      โ    โ PostgreSQL      โ
               โ Primary         โโโโโถโ Replica 1       โ
               โ (Port: 5432)    โ    โ (Port: 5433)    โ
               โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
                        โ
                        โผ
               โโโโโโโโโโโโโโโโโโโ
               โ PostgreSQL      โ
               โ Replica 2       โ
               โ (Port: 5434)    โ
               โโโโโโโโโโโโโโโโโโโ
```

## ๐ ะะพะผะฟะพะฝะตะฝัั

### PostgreSQL Primary (ะัะฝะพะฒะฝะพะน ัะตัะฒะตั)
- **ะะพัั**: 5432
- **ะะฐะทะฐ ะดะฐะฝะฝัั**: mydb
- **ะะพะปัะทะพะฒะฐัะตะปั**: admin
- **ะะฐัะพะปั**: secret
- **ะะตััะธั**: PostgreSQL 16 Alpine

### PostgreSQL Replica 1 & 2 (ะะตะฟะปะธะบะธ)
- **ะะพััั**: 5433, 5434
- **ะขะธะฟ**: ะคะธะทะธัะตัะบะธะต ัะตะฟะปะธะบะธ (streaming replication)
- **ะกะปะพัั ัะตะฟะปะธะบะฐัะธะธ**: replication_slot_1, replication_slot_2

### PgPool (ะะฐะปะฐะฝัะธัะพะฒัะธะบ ะฝะฐะณััะทะบะธ)
- **ะะพัั**: 9999
- **ะคัะฝะบัะธะธ**: 
  - ะะฐะปะฐะฝัะธัะพะฒะบะฐ ะฝะฐะณััะทะบะธ ััะตะฝะธั
  - ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ัะตัะฒะตัะพะฒ
  - ะัะพะบัะธัะพะฒะฐะฝะธะต ะฟะพะดะบะปััะตะฝะธะน

## ๐ ะัััััะน ะทะฐะฟััะบ

### ะัะตะดะฒะฐัะธัะตะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั
- Docker
- Docker Compose

### ะะฐะฟััะบ ะบะปะฐััะตัะฐ

```bash
# ะะปะพะฝะธัะพะฒะฐะฝะธะต ัะตะฟะพะทะธัะพัะธั
git clone <repository-url>
cd postgres-replica-pgpoll

# ะะฐะฟััะบ ะฒัะตั ัะตัะฒะธัะพะฒ
docker-compose up -d

# ะัะพะฒะตัะบะฐ ััะฐัััะฐ ัะตัะฒะธัะพะฒ
docker-compose ps
```

### ะัะพะฒะตัะบะฐ ัะฐะฑะพัั ัะตะฟะปะธะบะฐัะธะธ

```bash
# ะะพะดะบะปััะตะฝะธะต ะบ primary ัะตัะตะท PgPool
psql -h localhost -p 9999 -U admin -d mydb

# ะกะพะทะดะฐะฝะธะต ัะตััะพะฒะพะน ัะฐะฑะปะธัั
CREATE TABLE test_replication (id SERIAL PRIMARY KEY, data TEXT);
INSERT INTO test_replication (data) VALUES ('test data');

# ะัะพะฒะตัะบะฐ ะดะฐะฝะฝัั ะฝะฐ ัะตะฟะปะธะบะฐั
psql -h localhost -p 5433 -U admin -d mydb -c "SELECT * FROM test_replication;"
psql -h localhost -p 5434 -U admin -d mydb -c "SELECT * FROM test_replication;"
```

## โ๏ธ ะะพะฝัะธะณััะฐัะธั

### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

#### PostgreSQL Primary
```env
POSTGRES_USER=admin
POSTGRES_PASSWORD=secret
POSTGRES_DB=mydb
```

#### PostgreSQL Replicas
```env
PGUSER=replicator
PGPASSWORD=secret
```

#### PgPool
- ะะฐะปะฐะฝัะธัะพะฒะบะฐ ะฝะฐะณััะทะบะธ ะฒะบะปััะตะฝะฐ
- ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ะบะฐะถะดัะต 10 ัะตะบัะฝะด
- 32 ะดะพัะตัะฝะธั ะฟัะพัะตััะฐ
- ะะฐะบัะธะผัะผ 4 ะฟะพะดะบะปััะตะฝะธั ะฒ ะฟัะปะต

### ะะพััั
- **PgPool**: 9999 โ 5432 (ะพัะฝะพะฒะฝะฐั ัะพัะบะฐ ะฟะพะดะบะปััะตะฝะธั)
- **PostgreSQL Primary**: 5432 โ 5432
- **PostgreSQL Replica 1**: 5433 โ 5432
- **PostgreSQL Replica 2**: 5434 โ 5432

## ๐ง ะะฐัััะพะนะบะฐ ัะตะฟะปะธะบะฐัะธะธ

ะะตะฟะปะธะบะฐัะธั ะฝะฐัััะฐะธะฒะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะตัะตะท:

1. **init-primary.sh** - ัะพะทะดะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปั ัะตะฟะปะธะบะฐัะธะธ ะธ ัะปะพัั
2. **pg_basebackup** - ัะพะทะดะฐะตั ะฑะฐะทะพะฒัั ะบะพะฟะธั ะดะปั ัะตะฟะปะธะบ
3. **Streaming replication** - ัะธะฝััะพะฝะธะทะฐัะธั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ

### ะะฐัะฐะผะตััั ัะตะฟะปะธะบะฐัะธะธ

```sql
wal_level=replica
hot_standby=on
max_wal_senders=10
max_replication_slots=10
hot_standby_feedback=on
```

## ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ัะฟัะฐะฒะปะตะฝะธะต

### ะัะพะฒะตัะบะฐ ััะฐัััะฐ ัะตะฟะปะธะบะฐัะธะธ

```sql
-- ะะฐ primary ัะตัะฒะตัะต
SELECT client_addr, state, sync_state FROM pg_stat_replication;

-- ะัะพะฒะตัะบะฐ ัะปะพัะพะฒ ัะตะฟะปะธะบะฐัะธะธ
SELECT slot_name, active, restart_lsn FROM pg_replication_slots;
```

### ะัะพะฒะตัะบะฐ ัะตัะตะท PgPool

```bash
# ะกัะฐััั PgPool
docker exec pgpool pcp_node_info -h localhost -p 9898 -U admin -w

# ะะพะบะฐะทะฐัั ะบะพะฝัะธะณััะฐัะธั PgPool
docker exec pgpool cat /etc/pgpool2/pgpool.conf
```

### ะะพะณะธ

```bash
# ะะพะณะธ primary ัะตัะฒะตัะฐ
docker logs postgres-primary

# ะะพะณะธ ัะตะฟะปะธะบ
docker logs postgres-replica1
docker logs postgres-replica2

# ะะพะณะธ PgPool
docker logs pgpool
```

## ๐๏ธ ะฃัััะฐะฝะตะฝะธะต ะฝะตะฟะพะปะฐะดะพะบ

### ะัะพะฑะปะตะผั ั ะฟัะฐะฒะฐะผะธ ะดะพัััะฟะฐ ะบ Docker

ะัะปะธ ะฒั ะฟะพะปััะฐะตัะต ะพัะธะฑะบั "permission denied" ะฟัะธ ัะฐะฑะพัะต ั Docker:

```bash
# ะะพะฑะฐะฒะธัั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะณััะฟะฟั docker
sudo usermod -aG docker $USER

# ะะตัะตะทะฐะนัะธ ะฒ ัะธััะตะผั ะธะปะธ ะพะฑะฝะพะฒะธัั ะณััะฟะฟั
newgrp docker

# ะะปััะตัะฝะฐัะธะฒะฝะพ, ะฟะตัะตะทะฐะฟัััะธัั ัะตััะธั
# logout ะธ login ัะฝะพะฒะฐ
```

### ะัะพะฑะปะตะผั ั ะฟะพะดะบะปััะตะฝะธะตะผ ะบ ัะตะฟะปะธะบะฐะผ

1. ะัะพะฒะตัััะต, ััะพ primary ัะตัะฒะตั ะทะฐะฟััะตะฝ ะธ ะดะพัััะฟะตะฝ
2. ะฃะฑะตะดะธัะตัั, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั replicator ัะพะทะดะฐะฝ
3. ะัะพะฒะตัััะต pg_hba.conf ะฝะฐ primary ัะตัะฒะตัะต

### ะัะพะฑะปะตะผั ั PgPool

1. ะัะพะฒะตัััะต health check ะบะพะฝัะธะณััะฐัะธั
2. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต backend ัะตัะฒะตัั ะดะพัััะฟะฝั
3. ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ ะฐััะตะฝัะธัะธะบะฐัะธะธ

### ะกะฑัะพั ัะตะฟะปะธะบะฐัะธะธ

```bash
# ะััะฐะฝะพะฒะบะฐ ัะตัะฒะธัะพะฒ
docker-compose down

# ะฃะดะฐะปะตะฝะธะต volumes (ะฒัะฑะตัะธัะต ะพะดะธะฝ ะธะท ะฒะฐัะธะฐะฝัะพะฒ)
# ะะฐัะธะฐะฝั 1: ะฃะดะฐะปะตะฝะธะต ั ะฟะพะผะพััั docker-compose
docker-compose down -v

# ะะฐัะธะฐะฝั 2: ะััะฝะพะต ัะดะฐะปะตะฝะธะต volumes
docker volume ls | grep postgres-replica-pgpoll
docker volume rm postgres-replica-pgpoll_pg_primary_data postgres-replica-pgpoll_pg_replica1_data postgres-replica-pgpoll_pg_replica2_data

# ะะฐัะธะฐะฝั 3: ะฃะดะฐะปะตะฝะธะต ะฒัะตั ะฝะตะธัะฟะพะปัะทัะตะผัั volumes (ะฑัะดััะต ะพััะพัะพะถะฝั!)
docker volume prune

# ะะตัะตะทะฐะฟััะบ
docker-compose up -d
```

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
postgres-replica-pgpoll/
โโโ docker-compose.yml      # ะัะฝะพะฒะฝะฐั ะบะพะฝัะธะณััะฐัะธั Docker Compose
โโโ init-primary.sh         # ะกะบัะธะฟั ะธะฝะธัะธะฐะปะธะทะฐัะธะธ primary ัะตัะฒะตัะฐ
โโโ README.md               # ะญัะพั ัะฐะนะป
```

## ๐ ะะตะทะพะฟะฐัะฝะพััั

โ๏ธ **ะะฝะธะผะฐะฝะธะต**: ะะฐะฝะฝะฐั ะบะพะฝัะธะณััะฐัะธั ะฟัะตะดะฝะฐะทะฝะฐัะตะฝะฐ ะดะปั ัะฐะทัะฐะฑะพัะบะธ ะธ ัะตััะธัะพะฒะฐะฝะธั. ะะปั production ััะตะดั ะฝะตะพะฑัะพะดะธะผะพ:

- ะะทะผะตะฝะธัั ะฟะฐัะพะปะธ ะฟะพ ัะผะพะปัะฐะฝะธั
- ะะฐัััะพะธัั SSL/TLS
- ะะณัะฐะฝะธัะธัั ัะตัะตะฒะพะน ะดะพัััะฟ
- ะะฐัััะพะธัั ะผะพะฝะธัะพัะธะฝะณ ะธ ะฐะปะตััั
- ะะตะณัะปััะฝะพ ะพะฑะฝะพะฒะปััั ะพะฑัะฐะทั Docker

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะตััััั

- [ะะพะบัะผะตะฝัะฐัะธั PostgreSQL ะฟะพ ัะตะฟะปะธะบะฐัะธะธ](https://www.postgresql.org/docs/current/high-availability.html)
- [ะะพะบัะผะตะฝัะฐัะธั PgPool-II](https://www.pgpool.net/docs/latest/en/html/)
- [Docker ะพะฑัะฐะทั PostgreSQL](https://hub.docker.com/_/postgres)
- [Docker ะพะฑัะฐะทั PgPool](https://hub.docker.com/r/pgpool/pgpool)
